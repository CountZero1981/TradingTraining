<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Training</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .hidden {
            display: none;
        }

        .ticker-display, .situation-display {
            margin: 20px 0;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .price-step-btn {
            margin: 5px;
            padding: 10px 20px;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .input-group {
            margin: 20px 0;
        }

        .feedback {
            font-size: 1.2rem;
            margin-top: 10px;
        }

        .correct {
            color: green;
        }

        .incorrect {
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Trading Training</h1>
        <div>
            <label for="drawdown">Введите просадку (в рублях):</label>
            <input type="number" id="drawdown" class="form-control" placeholder="Например, 500" onkeydown="if(event.key === 'Enter'){setDrawdown();}">
            <button class="btn btn-primary mt-3" onclick="setDrawdown()">Установить просадку</button>
        </div>

        <div id="trainingSection" class="hidden">
            <div class="ticker-display" id="tickerDisplay">Тикер: </div>
            <div class="situation-display" id="situationDisplay">Ситуация: </div>
            <div id="priceStepSection">
                <p>Выбери стоимость шага цены:</p>
                <div id="priceStepButtons">
                    <!-- Кнопки для выбора стоимости шага цены будут генерироваться здесь -->
                </div>
            </div>

            <div class="input-group">
                <input type="number" id="positionSize" class="form-control" placeholder="Введите размер позиции" onkeydown="if(event.key === 'Enter'){checkPosition();}">
                <button class="btn btn-primary" onclick="checkPosition()">Отправить</button>
                <button class="btn btn-secondary ms-2" onclick="skipRound()">Пропустить</button>
            </div>

            <div id="feedback" class="feedback"></div>
            <div id="statisticsDisplay" class="mt-3"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const tickers = {
            "SBER": {"lot_size": 10, "price_step": 0.01, "StepCost": 0.1},
            "MTLR": {"lot_size": 10, "price_step": 0.01, "StepCost": 0.1},
            "AFKS": {"lot_size": 100, "price_step": 0.001, "StepCost": 0.1},
            "MOEX": {"lot_size": 10, "price_step": 0.01, "StepCost": 0.1},
            "WUSH": {"lot_size": 10, "price_step": 0.01, "StepCost": 0.1},
            "APTK": {"lot_size": 10, "price_step": 0.002, "StepCost": 0.02},
            "RNFT": {"lot_size": 10, "price_step": 0.01, "StepCost": 0.1},
            "SGZH": {"lot_size": 10, "price_step": 0.01, "StepCost": 0.1},
            "MVID": {"lot_size": 10, "price_step": 0.01, "StepCost": 0.1}
        };

        const situations = ["A+", "A", "B", "C"];
        const situationProbabilities = {
            "A+": 0.05,
            "A": 0.20,
            "B": 0.70,
            "C": 0.05
        };

        const risks = [10, 20, 30, 50, 100, 150, 200];

        let currentTicker = '';
        let currentSituation = '';
        let currentRisk = 0;
        let drawdown = 0;
        let statistics = {};

        // Инициализация статистики
        for (const ticker in tickers) {
            statistics[ticker] = { correct: 0, incorrect: 0 };
        }

        function setDrawdown() {
            drawdown = document.getElementById('drawdown').value;
            if (drawdown) {
                document.getElementById('trainingSection').classList.remove('hidden');
                startNewRound();
            }
        }
        function startNewRound() {
            currentTicker = getRandomTicker();
            currentSituation = getRandomSituation();
            currentRisk = getRandomRisk(currentTicker);

            document.getElementById('tickerDisplay').textContent = `Тикер: ${currentTicker}`;
            document.getElementById('situationDisplay').textContent = `Ситуация: ${currentSituation} (Риск: ${currentRisk} пунктов)`;

            generatePriceStepButtons();
        }

        function skipRound() {
            startNewRound();
        }

        function getRandomTicker() {
            const tickerKeys = Object.keys(tickers);
            return tickerKeys[Math.floor(Math.random() * tickerKeys.length)];
        }

        function getRandomSituation() {
            const randomValue = Math.random();
            let cumulativeProbability = 0;

            for (const situation of situations) {
                cumulativeProbability += situationProbabilities[situation];
                if (randomValue < cumulativeProbability) {
                    return situation;
                }
            }

            return "B"; // На случай, если что-то пойдет не так
        }

        function getRandomRisk(ticker) {
            if (["MTLR", "AFKS", "MOEX", "WUSH", "APTK"].includes(ticker)) {
                return risks[Math.floor(Math.random() * 4) + 3]; // 50, 100, 150, 200
            } else if (["RNFT", "SGZH", "MVID"].includes(ticker)) {
                return 5;
            } else {
                return risks[Math.floor(Math.random() * 3)]; // 10, 20, 30
            }
        }
        function generatePriceStepButtons() {
            const correctStep = tickers[currentTicker].StepCost;
            const priceStepOptions = [correctStep];

            const totalButtons = Math.floor(Math.random() * 5) + 3; // Генерируем от 3 до 7 кнопок

            while (priceStepOptions.length < totalButtons) {
                const randomStep = getRandomPriceStep();
                if (!priceStepOptions.includes(randomStep)) {
                    priceStepOptions.push(randomStep);
                }
            }
            priceStepOptions.sort(() => Math.random() - 0.5); // Перемешиваем варианты

            const priceStepButtonsDiv = document.getElementById('priceStepButtons');
            priceStepButtonsDiv.innerHTML = ''; // Очищаем перед добавлением новых кнопок

            priceStepOptions.forEach(step => {
                const button = document.createElement('button');
                button.textContent = `${step} руб.`;
                button.classList.add('btn', 'btn-secondary', 'price-step-btn');
                button.onclick = () => checkPriceStep(step);
                priceStepButtonsDiv.appendChild(button);
            });
        }

        function getRandomPriceStep() {
            const steps = [0.01, 0.02, 0.05, 0.1, 0.2, 0.5, 1];
            return steps[Math.floor(Math.random() * steps.length)];
        }

        function checkPriceStep(selectedStep) {
            const correctStep = tickers[currentTicker].StepCost;
            const feedback = document.getElementById('feedback');
            if (selectedStep === correctStep) {
                feedback.textContent = 'Правильно! Теперь введите размер позиции.';
                feedback.classList.remove('incorrect');
                feedback.classList.add('correct');
                playSound('correct.mp3');
                document.getElementById('positionSize').focus();
                statistics[currentTicker].correct++;
            } else {
                feedback.textContent = 'Неправильно! Попробуйте снова.';
                feedback.classList.remove('correct');
                feedback.classList.add('incorrect');
                playSound('incorrect.mp3');
                statistics[currentTicker].incorrect++;
            }
        }
        function checkPosition() {
            const positionSizeInput = document.getElementById('positionSize').value;
            const expectedPositionSize = calculatePositionSize();
            const feedback = document.getElementById('feedback');

            if (parseInt(positionSizeInput) === expectedPositionSize) {
                feedback.textContent = 'Правильный размер позиции!';
                feedback.classList.remove('incorrect');
                feedback.classList.add('correct');
                playSound('correct.mp3');
                // updateStatistics();
				document.getElementById('positionSize').value = '';
                startNewRound(); // Запуск нового раунда только после правильного ответа
            } else {
                feedback.textContent = `Неправильный размер позиции. Ожидалось: ${expectedPositionSize}`;
                feedback.classList.remove('correct');
                feedback.classList.add('incorrect');
                playSound('incorrect.mp3');
            }
        }

        function calculatePositionSize() {
            const stepCost = tickers[currentTicker].StepCost;
            const baseSize = drawdown / stepCost / currentRisk / 20;

            switch (currentSituation) {
                case "A+":
                    return Math.round(baseSize * 6.6);
                case "A":
                    return Math.round(baseSize * 4);
                case "B":
                    return Math.round(baseSize * 2);
                case "C":
                    return Math.round(baseSize);
            }
        }

        function updateStatistics() {
            const statsDiv = document.getElementById('statisticsDisplay');
            statsDiv.innerHTML = '<h3>Статистика</h3>';
            for (const ticker in statistics) {
                const stat = statistics[ticker];
                statsDiv.innerHTML += `<p>${ticker}: Правильно - ${stat.correct}, Неправильно - ${stat.incorrect}</p>`;
            }
        }

        function playSound(filename) {
            const audio = new Audio(filename);
            audio.play();
        }
    </script>
</body>
</html>
